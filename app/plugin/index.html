<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RewardX Plugin - å¼€å‘é¢„è§ˆ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
          'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
          sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        background: white;
        padding: 24px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 28px;
        margin-bottom: 8px;
        color: #1a1a1a;
      }

      .subtitle {
        color: #666;
        font-size: 14px;
      }

      .preview-section {
        background: white;
        border-radius: 8px;
        padding: 40px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        min-height: 600px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
      }

      .info {
        margin-top: 20px;
        padding: 16px;
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        border-radius: 4px;
        font-size: 14px;
        line-height: 1.6;
      }

      .info h3 {
        font-size: 16px;
        margin-bottom: 8px;
        color: #1976d2;
      }

      .code {
        margin-top: 12px;
        padding: 12px;
        background: #263238;
        border-radius: 4px;
        overflow-x: auto;
      }

      .code pre {
        color: #aed581;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.6;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>RewardX Plugin - å¼€å‘é¢„è§ˆ</h1>
      </div>

        <!-- ç»„ä»¶å®¹å™¨ -->
      <div id="rewardx-lottery-preview"></div>

      <div class="info">
        <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
        <p>
          è¿™æ˜¯å®¢æˆ·ç«¯æŠ½å¥–ç»„ä»¶çš„å¼€å‘é¢„è§ˆé¡µé¢ã€‚ç»„ä»¶ä½¿ç”¨ <strong>PreviewGame</strong> å½¢å¼ï¼ˆç›´æ¥æ˜¾ç¤ºï¼Œä¸ä½¿ç”¨å¼¹çª—ï¼‰ï¼Œ
          ä¼šä» API æ¥å£è·å–æœ€æ–°çš„æ´»è·ƒæ´»åŠ¨æ•°æ®ã€‚
        </p>
        <div class="code">
          <pre># å¼€å‘æ¨¡å¼ï¼ˆçƒ­æ›´æ–°ï¼‰
npm run dev:plugin

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build:plugin

# æ„å»ºäº§ç‰©ä½ç½®
extensions/rewardx-lottery-extension/assets/lottery-game.js

# æŒ‡å®š shop å‚æ•°ï¼ˆå¯é€‰ï¼‰
http://localhost:5173/plugin/index.html?shop=your-shop.myshopify.com</pre>
        </div>
      </div>

      <div class="info">
        <h3>ğŸ’¡ åœ¨ Admin ä¸­ä½¿ç”¨</h3>
        <div class="code">
          <pre>import { PreviewGame } from "@plugin/main"

&lt;PreviewGame
  isAdmin={true}
/&gt;</pre>
        </div>
      </div>

      <div class="info">
        <h3>ğŸŒ åœ¨ Storefront ä¸­ä½¿ç”¨</h3>
        <div class="code">
          <pre>import { PreviewGame } from "@plugin/main"

&lt;PreviewGame
  campaign={campaign}
  isAdmin={false}
  onPrizeWon={(prize) => console.log(prize)}
/&gt;</pre>
        </div>
      </div>
    </div>

    <script>var Shopify = Shopify || {};
    Shopify.shop = "baoea.myshopify.com";
    Shopify.locale = "en";
    Shopify.currency = {"active":"HKD","rate":"1.0"};
    Shopify.country = "HK";
    Shopify.theme = {"name":"Horizon","id":187331674193,"schema_name":"Horizon","schema_version":"3.1.0","theme_store_id":2481,"role":"main"};
    Shopify.theme.handle = "null";
    Shopify.theme.style = {"id":null,"handle":null};
    Shopify.cdnHost = "baoea.myshopify.com/cdn";
    Shopify.routes = Shopify.routes || {};
    Shopify.routes.root = "/";
    Shopify.previewMode = true;</script>

    <script type="module">
      // ä» URL æŸ¥è¯¢å‚æ•°è·å– shop åŸŸåï¼Œæˆ–ä½¿ç”¨é»˜è®¤å€¼
      const urlParams = new URLSearchParams(window.location.search)
      const shopParam = urlParams.get("shop")
      const shop = shopParam || "baoea.myshopify.com" // é»˜è®¤ shopï¼Œç”¨äºå¼€å‘é¢„è§ˆ

      // è§„èŒƒåŒ– URLï¼Œç¡®ä¿åè®®æ­£ç¡®
      const normalizeUrl = (url) => {
        if (!url) return url

        let normalized = String(url).trim().replace(/\/+$/, "")

        // å¦‚æœ URL æ²¡æœ‰åè®®ï¼Œæ·»åŠ åè®®
        if (!normalized.match(/^https?:\/\//)) {
          normalized = `${window.location.protocol}//${normalized}`
        }

        // å¦‚æœå½“å‰é¡µé¢æ˜¯ HTTPSï¼Œä½† URL æ˜¯ HTTPï¼Œè½¬æ¢ä¸º HTTPS
        if (window.location.protocol === "https:") {
          normalized = normalized.replace(/^http:\/\//, "https://")
        }

        return normalized
      }

      // è·å–åº”ç”¨ API URL
      const getAppApiUrl = () => {
        // 1. ä¼˜å…ˆä½¿ç”¨ Vite æ³¨å…¥çš„ç¯å¢ƒå˜é‡ï¼ˆimport.meta.envï¼‰
        try {
          const envUrl = import.meta.env.REWARDX_APP_URL || import.meta.env.SHOPIFY_APP_URL || import.meta.env.VITE_REWARDX_APP_URL || import.meta.env.VITE_SHOPIFY_APP_URL

          if (envUrl && envUrl !== "") {
            return normalizeUrl(String(envUrl))
          }
        } catch (e) {
          // å¿½ç•¥é”™è¯¯
        }

        // 2. å¼€å‘ç¯å¢ƒï¼šå¦‚æœå½“å‰æ˜¯ Vite dev server (ç«¯å£ 5174)ï¼Œåˆ™ä½¿ç”¨ä¸»æœåŠ¡å™¨ (ç«¯å£ 3000)
        const currentOrigin = window.location.origin
        const currentPort = window.location.port

        // å¦‚æœæ˜¯ Vite dev server (5174)ï¼Œä»£ç†åˆ°ä¸»æœåŠ¡å™¨ (3000)
        if (currentPort === "5174" || currentOrigin.includes(":5174")) {
          return currentOrigin.replace(":5174", ":3000").replace(/\/+$/, "")
        }

        // 3. æœ€åå›é€€ï¼šä½¿ç”¨å½“å‰åŸŸåï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
        return currentOrigin.replace(/\/+$/, "")
      }

      // æ„å»º API URL
      const buildApiUrl = (endpoint) => {
        const apiBase = getAppApiUrl()

        const cleanEndpoint = endpoint.startsWith("/") ? endpoint.slice(1) : endpoint
        return `${apiBase}/api/${cleanEndpoint}`
      }

      // ä»æ¥å£è·å–æœ€æ–°çš„æ´»è·ƒæ´»åŠ¨
      const fetchCampaign = async () => {
        try {
          const apiUrl = buildApiUrl(`/campaigns/latest?shop=${shop}`)
          console.log("ğŸ“¡ Fetching campaign from:", apiUrl)

          const response = await fetch(apiUrl, {
            credentials: "include",
            headers: {
              "Content-Type": "application/json"
            }
          })

          if (!response.ok) {
            // å°è¯•è¯»å–é”™è¯¯å“åº”å†…å®¹
            const contentType = response.headers.get("content-type")
            let errorMessage = `HTTP ${response.status}: ${response.statusText}`

            if (contentType && contentType.includes("application/json")) {
              try {
                const errorData = await response.json()
                errorMessage = errorData.error || errorData.message || errorMessage
              } catch (e) {
                // å¿½ç•¥ JSON è§£æé”™è¯¯
              }
            } else {
              // å¦‚æœæ˜¯ HTML å“åº”ï¼Œå¯èƒ½æ˜¯é”™è¯¯é¡µé¢
              const text = await response.text()
              if (text.includes("<")) {
                errorMessage = `Server returned HTML instead of JSON. This usually means the API endpoint doesn't exist or the server isn't running.`
              }
            }

            throw new Error(errorMessage)
          }

          // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
          const contentType = response.headers.get("content-type")
          if (!contentType || !contentType.includes("application/json")) {
            const text = await response.text()
            console.error("âŒ Unexpected response type:", contentType)
            console.error("Response text:", text.substring(0, 200))
            throw new Error(`Expected JSON but got ${contentType || "unknown"}. The API endpoint may not be configured correctly.`)
          }

          const data = await response.json()
          console.log("ğŸ“¦ Campaign data:", data)

          if (data.success && data.campaign) {
            return data.campaign
          } else if (data.success && !data.campaign) {
            throw new Error("No active campaign found for this shop")
          } else {
            throw new Error(data.error || "Failed to load campaign")
          }
        } catch (error) {
          console.error("âŒ Failed to fetch campaign:", error)
          throw error
        }
      }

      // ç­‰å¾…æ¨¡å—åŠ è½½åè·å–æ•°æ®å¹¶æ¸²æŸ“
      import("/main.tsx").then(async (module) => {
        const container = document.getElementById("rewardx-lottery-preview")
        if (!container) {
          console.error("âŒ Container not found")
          return
        }

        try {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading campaign...</div>'

          // è·å–æ´»åŠ¨æ•°æ®
          const campaign = await fetchCampaign()

          // ä½¿ç”¨ PreviewGame æ¸²æŸ“ï¼ˆä¸æ˜¯å¼¹çª—ï¼‰
          // åŠ¨æ€å¯¼å…¥ PreviewGame ç»„ä»¶ï¼ˆé¿å…å¾ªç¯ä¾èµ–ï¼‰
          const React = await import("react")
          const ReactDOM = await import("react-dom/client")

          // åŠ¨æ€å¯¼å…¥ PreviewGame ç»„ä»¶
          let PreviewGameComponent = null

          // æ–¹æ³•1ï¼šå°è¯•ä» main.tsx çš„ getPreviewGame è·å–
          if (module.getPreviewGame) {
            try {
              PreviewGameComponent = await module.getPreviewGame()
              console.log("âœ… Got PreviewGame from getPreviewGame")
            } catch (e) {
              console.warn("âš ï¸ Failed to get PreviewGame from getPreviewGame:", e)
            }
          }

          // æ–¹æ³•2ï¼šå¦‚æœæ–¹æ³•1å¤±è´¥ï¼Œç›´æ¥å¯¼å…¥ç»„ä»¶æ–‡ä»¶ï¼ˆç›¸å¯¹äº plugin ç›®å½•ï¼‰
          if (!PreviewGameComponent) {
            try {
              // ä» plugin/component/PreviewGame.tsx å¯¼å…¥
              const PreviewGameModule = await import("./component/PreviewGame.tsx")
              PreviewGameComponent = PreviewGameModule.PreviewGame || PreviewGameModule.default
              console.log("âœ… Got PreviewGame from direct import")
            } catch (e) {
              console.error("âŒ Failed to import PreviewGame:", e)
              throw new Error(`PreviewGame component not found: ${e.message}`)
            }
          }

          if (!PreviewGameComponent) {
            throw new Error("PreviewGame component not found. Make sure the component is properly exported.")
          }

          const root = ReactDOM.createRoot(container)
          root.render(
            React.createElement(PreviewGameComponent, {
              campaign: campaign,
              isAdmin: false, // å¼€å‘é¢„è§ˆæ¨¡å¼
              onPrizeWon: (prize) => {
                console.log("ğŸ‰ Prize won:", prize)
              }
            })
          )
        } catch (error) {
          console.error("âŒ Failed to render:", error)
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #d32f2f;">
              <h3>Failed to load campaign</h3>
              <p>${error.message}</p>
              <p style="margin-top: 16px; font-size: 14px; color: #666;">
                Shop: ${shop}<br/>
                Make sure the API server is running and the shop has an active campaign.
              </p>
            </div>
          `
        }
      })
    </script>
  </body>
</html>
