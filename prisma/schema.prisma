generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AnalyticsEvent {
  id         String   @id
  userId     String?
  shop       String?
  campaignId String?
  eventType  String
  eventData  String?  @default("{}")
  timestamp  DateTime @default(now())

  @@index([campaignId, timestamp])
  @@index([eventType, timestamp])
  @@index([userId, timestamp])
}

model Campaign {
  id                  String         @id
  userId              String
  name                String
  description         String?
  type                String         @default("order")
  gameType            String         @default("ninebox")
  minOrderAmount      Float?
  allowedOrderStatus  String         @default("paid")
  requireOrder        Boolean        @default(true)
  requireName         Boolean        @default(false)
  requirePhone        Boolean        @default(false)
  maxPlaysPerCustomer Int?           @default(1)
  startAt             DateTime?
  endAt               DateTime?
  status              String         @default("draft")
  isActive            Boolean        @default(false)
  gameConfig          String         @default("{}")
  totalPlays          Int            @default(0)
  totalWins           Int            @default(0)
  totalOrders         Int            @default(0)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime
  User                User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  LotteryEntry        LotteryEntry[]
  Prize               Prize[]

  @@index([gameType])
  @@index([startAt, endAt])
  @@index([status, isActive])
  @@index([type, status])
  @@index([userId, status])
}

model Discount {
  id              String         @id
  code            String         @unique
  type            String
  value           Float
  applicablePlans String?
  billingCycles   String?
  maxUses         Int?
  currentUses     Int            @default(0)
  maxUsesPerUser  Int?           @default(1)
  startsAt        DateTime?
  expiresAt       DateTime?
  isActive        Boolean        @default(true)
  description     String?
  internalNotes   String?
  metadata        String?        @default("{}")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime
  Subscription    Subscription[]
  UserDiscount    UserDiscount[]

  @@index([code, isActive])
}

model LotteryEntry {
  id              String    @id
  campaignId      String
  userId          String?
  campaignType    String
  orderId         String?   @unique
  orderNumber     String?
  orderAmount     Float?
  order           String?
  customerName    String?
  phone           String?
  customerId      String?
  prizeId         String?
  prizeName       String?
  prizeType       String?
  prizeValue      String?
  isWinner        Boolean   @default(false)
  status          String    @default("pending")
  discountCode    String?
  discountCodeId  String?
  claimedAt       DateTime?
  usedOrderId     String?
  usedOrderAmount Float?
  expiresAt       DateTime?
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  Campaign        Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  Prize           Prize?    @relation(fields: [prizeId], references: [id])
  User            User?     @relation(fields: [userId], references: [id])

  @@index([campaignId, createdAt])
  @@index([campaignType])
  @@index([customerId])
  @@index([order])
  @@index([isWinner])
  @@index([orderId])
  @@index([status])
  @@index([userId, createdAt])
}

model Payment {
  id                 String        @id
  userId             String
  subscriptionId     String?
  shopifyChargeId    String?       @unique
  amount             Float
  currency           String        @default("USD")
  status             String
  billingPeriodStart DateTime?
  billingPeriodEnd   DateTime?
  invoiceUrl         String?
  metadata           String?       @default("{}")
  paidAt             DateTime?
  refundedAt         DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime
  Subscription       Subscription? @relation(fields: [subscriptionId], references: [id])
  User               User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([shopifyChargeId])
  @@index([userId, createdAt])
}

model Prize {
  id               String         @id
  campaignId       String
  name             String
  description      String?
  type             String
  discountValue    Float?
  discountCode     String?
  giftProductId    String?
  giftVariantId    String?
  chancePercentage Float          @default(0)
  totalStock       Int?
  usedStock        Int            @default(0)
  displayOrder     Int            @default(0)
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  image            String?
  activeImage      String?
  LotteryEntry     LotteryEntry[]
  Campaign         Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId, displayOrder])
  @@index([campaignId, isActive])
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  order         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  orderVerified Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model SetupGuide {
  id             String    @id
  userId         String    @unique
  tasks          String    @default("[]")
  totalTasks     Int       @default(4)
  completedTasks Int       @default(0)
  isCompleted    Boolean   @default(false)
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  updatedAt      DateTime
  User           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Subscription {
  id                 String        @id
  userId             String
  shopifyChargeId    String?       @unique
  shopifyConfirmUrl  String?
  planType           String
  billingCycle       String
  price              Float
  originalPrice      Float
  currency           String        @default("USD")
  quotaLimit         Int
  quotaUsed          Int           @default(0)
  quotaResetAt       DateTime
  status             String
  isTrial            Boolean       @default(false)
  trialDays          Int           @default(0)
  trialStartAt       DateTime?
  trialEndAt         DateTime?
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAt           DateTime?
  cancelledAt        DateTime?
  discountId         String?
  discountAmount     Float         @default(0)
  discountType       String?
  isManualGrant      Boolean       @default(false)
  grantedBy          String?
  grantReason        String?
  grantExpiresAt     DateTime?
  metadata           String?       @default("{}")
  createdAt          DateTime      @default(now())
  updatedAt          DateTime
  Payment            Payment[]
  Discount           Discount?     @relation(fields: [discountId], references: [id])
  User               User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  UsageRecord        UsageRecord[]

  @@index([shopifyChargeId])
  @@index([userId, status])
}

model UsageRecord {
  id             String       @id
  userId         String
  subscriptionId String
  action         String
  quantity       Int          @default(1)
  quotaUsed      Int          @default(1)
  resourceType   String?
  resourceId     String?
  metadata       String?      @default("{}")
  createdAt      DateTime     @default(now())
  Subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  User           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([subscriptionId, createdAt])
  @@index([userId, createdAt])
}

model User {
  id              String         @id
  shop            String         @unique
  shopId          String?
  order           String?
  shopName        String?
  domain          String?
  myshopifyDomain String?
  primaryDomain   String?
  primaryLocale   String?
  ownerName       String?
  firstName       String?
  lastName        String?
  country         String?
  countryCode     String?
  city            String?
  province        String?
  address         String?
  zip             String?
  phone           String?
  currency        String?
  currencyCode    String         @default("USD")
  language        String         @default("en")
  appLanguage     String?
  timezone        String?
  ianaTimezone    String?
  planName        String?
  planDisplayName String?
  isShopifyPlus   Boolean        @default(false)
  isPartnerDev    Boolean        @default(false)
  theme           String         @default("light")
  notifications   Boolean        @default(true)
  appRating       Int?
  appReview       String?
  reviewedAt      DateTime?
  installedAt     DateTime       @default(now())
  lastLoginAt     DateTime       @default(now())
  lastSyncAt      DateTime       @default(now())
  isActive        Boolean        @default(true)
  isTrial         Boolean        @default(true)
  trialEndsAt     DateTime?
  settings        String?        @default("{}")
  metadata        String?        @default("{}")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime
  Campaign        Campaign[]
  LotteryEntry    LotteryEntry[]
  Payment         Payment[]
  SetupGuide      SetupGuide?
  Subscription    Subscription[]
  UsageRecord     UsageRecord[]
  UserDiscount    UserDiscount[]
}

model UserDiscount {
  id         String   @id @default(uuid())
  userId     String
  discountId String
  usedCount  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  Discount   Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, discountId])
  @@index([userId])
}
