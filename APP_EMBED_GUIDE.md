# ğŸš€ App Embed è‡ªåŠ¨æ£€æµ‹ä¸å¯ç”¨å®Œæ•´å®ç°æŒ‡å—

## âœ… å®Œæˆçš„åŠŸèƒ½

### 1. **çœŸå®çš„çŠ¶æ€æ£€æµ‹**
- âœ… ä½¿ç”¨ Shopify Theme Asset API è¯»å– `settings_data.json`
- âœ… ç²¾ç¡®è§£æ `current.blocks` é…ç½®
- âœ… åŒ¹é…åº”ç”¨çš„ API Key å’Œ App Embed Block
- âœ… è¿”å›å‡†ç¡®çš„å¯ç”¨çŠ¶æ€

### 2. **ä¸€é”®è‡ªåŠ¨å¯ç”¨**
- âœ… è‡ªåŠ¨è·å–å½“å‰ä¸»é¢˜
- âœ… è¯»å–ä¸»é¢˜è®¾ç½®æ–‡ä»¶
- âœ… æ·»åŠ  App Embed é…ç½®
- âœ… ä¿å­˜æ›´æ–°åˆ°ä¸»é¢˜
- âœ… é˜²æ­¢é‡å¤å¯ç”¨

### 3. **æ™ºèƒ½ Banner ç»„ä»¶**
- âœ… é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹çŠ¶æ€
- âœ… å·²å¯ç”¨æ—¶è‡ªåŠ¨éšè—
- âœ… æœªå¯ç”¨æ—¶æ˜¾ç¤ºæç¤º
- âœ… æ”¯æŒä¸€é”®å¯ç”¨å’Œæ‰‹åŠ¨è®¾ç½®
- âœ… é”™è¯¯å¤„ç†å’ŒçŠ¶æ€åé¦ˆ
- âœ… 7å¤©åé‡æ–°æé†’æœºåˆ¶

## ğŸ“ æ–°å¢æ–‡ä»¶

### `/app/utils/theme.server.ts`
å¼ºå¤§çš„ Theme API å·¥å…·ç±»ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

```typescript
// è·å–å½“å‰ä¸»é¢˜
getCurrentTheme(admin): Promise<Theme | null>

// è¯»å–ä¸»é¢˜è®¾ç½®
getThemeSettings(admin, themeId): Promise<ThemeSettings | null>

// æ›´æ–°ä¸»é¢˜è®¾ç½®
updateThemeSettings(admin, themeId, settings): Promise<boolean>

// æ£€æŸ¥ App Embed çŠ¶æ€
checkAppEmbedEnabled(admin, appApiKey): Promise<{
  isEnabled: boolean
  blockId?: string
  themeId?: string
  themeName?: string
}>

// å¯ç”¨ App Embed
enableAppEmbed(admin, appApiKey, appHandle): Promise<{
  success: boolean
  blockId?: string
  error?: string
}>

// ç¦ç”¨ App Embed
disableAppEmbed(admin, appApiKey): Promise<boolean>
```

## ğŸ” æƒé™é…ç½®

### `shopify.app.toml` æ›´æ–°
```toml
scopes = "read_products,write_products,read_customers,read_orders,read_content,read_themes,write_themes,read_locales"
```

**é‡è¦å˜æ›´ï¼š**
- âœ… æ·»åŠ äº† `write_themes` æƒé™
- âš ï¸ é¦–æ¬¡æ·»åŠ æƒé™åï¼Œç”¨æˆ·éœ€è¦é‡æ–°æˆæƒåº”ç”¨

### é‡æ–°æˆæƒæµç¨‹
```bash
# 1. åœæ­¢å¼€å‘æœåŠ¡å™¨
Ctrl+C

# 2. é‡æ–°å¯åŠ¨ï¼ˆä¼šè§¦å‘é‡æ–°æˆæƒï¼‰
npm run dev

# 3. åœ¨æµè§ˆå™¨ä¸­é‡æ–°å®‰è£…åº”ç”¨
# Shopify ä¼šæç¤ºæ–°çš„æƒé™è¯·æ±‚
```

## ğŸ”§ æŠ€æœ¯å®ç°

### æ£€æµ‹é€»è¾‘æµç¨‹
```
ç”¨æˆ·æ‰“å¼€åº”ç”¨
    â†“
GET /api/checkAppEmbed
    â†“
getCurrentTheme() â†’ è·å–ä¸»é¢˜ ID
    â†“
getThemeSettings() â†’ è¯»å– settings_data.json
    â†“
è§£æ current.blocks æŸ¥æ‰¾ App Embed
    â†“
è¿”å› { isEnabled: true/false, themeId, themeName }
    â†“
Banner æ ¹æ®çŠ¶æ€æ˜¾ç¤º/éšè—
```

### è‡ªåŠ¨å¯ç”¨æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»"ä¸€é”®å¯ç”¨"
    â†“
POST /api/checkAppEmbed
    â†“
getCurrentTheme() â†’ è·å–ä¸»é¢˜
    â†“
getThemeSettings() â†’ è¯»å–å½“å‰è®¾ç½®
    â†“
æ£€æŸ¥æ˜¯å¦å·²å¯ç”¨ï¼ˆé˜²æ­¢é‡å¤ï¼‰
    â†“
ç”Ÿæˆå”¯ä¸€ block ID: app-embed-{timestamp}
    â†“
æ·»åŠ  App Embed é…ç½®:
{
  type: "shopify://apps/smart-seo/blocks/app-embed/40572ca771d68b503541a8837c8b24e0",
  disabled: false,
  settings: {}
}
    â†“
updateThemeSettings() â†’ ä¿å­˜åˆ°ä¸»é¢˜
    â†“
è¿”å› { success: true, blockId }
    â†“
Banner æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼Œ2ç§’åè‡ªåŠ¨éšè—
```

## ğŸ¨ ç”¨æˆ·ä½“éªŒ

### Banner çŠ¶æ€å˜åŒ–
```
[åŠ è½½ä¸­] â†’ æ£€æµ‹ä¸­ï¼Œä¸æ˜¾ç¤ºä»»ä½•å†…å®¹ï¼ˆé¿å…é—ªçƒï¼‰
    â†“
[æœªå¯ç”¨] â†’ æ˜¾ç¤ºé»„è‰² Warning Banner
    â”œâ”€ [ä¸€é”®å¯ç”¨] â†’ ç‚¹å‡»åæ˜¾ç¤º Loading çŠ¶æ€
    â”‚  â”œâ”€ æˆåŠŸ â†’ æ˜¾ç¤ºç»¿è‰²æˆåŠŸæ¶ˆæ¯ â†’ 2ç§’åè‡ªåŠ¨éšè— âœ…
    â”‚  â””â”€ å¤±è´¥ â†’ æ˜¾ç¤ºçº¢è‰²é”™è¯¯æ¶ˆæ¯ âŒ
    â”œâ”€ [æ‰‹åŠ¨è®¾ç½®] â†’ æ‰“å¼€ä¸»é¢˜ç¼–è¾‘å™¨ï¼ˆæ–°çª—å£ï¼‰
    â””â”€ [ç¨åæé†’æˆ‘] â†’ éšè— Bannerï¼Œ7å¤©åé‡æ–°æé†’
    â†“
[å·²å¯ç”¨] â†’ ä¸æ˜¾ç¤º Banner âœ…
```

### è§†è§‰æ•ˆæœç¤ºä¾‹

**æœªå¯ç”¨çŠ¶æ€ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸  å¯ç”¨åº”ç”¨åµŒå…¥ä»¥è·å¾—å®Œæ•´åŠŸèƒ½                  [X] â”‚
â”‚                                                    â”‚
â”‚ ä¸ºäº†è®©åº”ç”¨åœ¨æ‚¨çš„åº—é“ºå‰å°æ­£å¸¸å·¥ä½œï¼Œè¯·å¯ç”¨åº”ç”¨åµŒå…¥ã€‚ â”‚
â”‚ æ‚¨å¯ä»¥ä¸€é”®è‡ªåŠ¨å¯ç”¨ï¼Œæˆ–æ‰‹åŠ¨åœ¨ä¸»é¢˜ç¼–è¾‘å™¨ä¸­è®¾ç½®ã€‚     â”‚
â”‚                                                    â”‚
â”‚ [ä¸€é”®å¯ç”¨] [æ‰‹åŠ¨è®¾ç½®] [ç¨åæé†’æˆ‘]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯ç”¨æˆåŠŸçŠ¶æ€ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… å¯ç”¨åº”ç”¨åµŒå…¥ä»¥è·å¾—å®Œæ•´åŠŸèƒ½                  [X] â”‚
â”‚                                                    â”‚
â”‚ âœ… åº”ç”¨åµŒå…¥å·²æˆåŠŸå¯ç”¨ï¼                            â”‚
â”‚                                                    â”‚
â”‚ ï¼ˆ2ç§’åè‡ªåŠ¨éšè—ï¼‰                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š API ç«¯ç‚¹è¯¦æƒ…

### GET `/api/checkAppEmbed`
**åŠŸèƒ½ï¼š** æ£€æµ‹ App Embed çŠ¶æ€

**å“åº”ç¤ºä¾‹ï¼ˆå·²å¯ç”¨ï¼‰ï¼š**
```json
{
  "isEnabled": true,
  "blockId": "app-embed-1699123456789",
  "themeId": "123456789",
  "themeName": "Dawn",
  "shop": "example.myshopify.com",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

**å“åº”ç¤ºä¾‹ï¼ˆæœªå¯ç”¨ï¼‰ï¼š**
```json
{
  "isEnabled": false,
  "themeId": "123456789",
  "themeName": "Dawn",
  "shop": "example.myshopify.com",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### POST `/api/checkAppEmbed`
**åŠŸèƒ½ï¼š** è‡ªåŠ¨å¯ç”¨ App Embed

**å“åº”ç¤ºä¾‹ï¼ˆæˆåŠŸï¼‰ï¼š**
```json
{
  "success": true,
  "blockId": "app-embed-1699123456789",
  "shop": "example.myshopify.com",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

**å“åº”ç¤ºä¾‹ï¼ˆå¤±è´¥ï¼‰ï¼š**
```json
{
  "success": false,
  "error": "Failed to update theme settings",
  "shop": "example.myshopify.com",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

## ğŸ› è°ƒè¯•æ—¥å¿—

### æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹
```bash
# æ£€æµ‹çŠ¶æ€
ğŸ” å¼€å§‹æ£€æµ‹ App Embed çŠ¶æ€...
ğŸ” è·å–å½“å‰ä¸»é¢˜...
âœ… æ‰¾åˆ°ä¸»é¢˜: Dawn ID: 123456789
ğŸ“– è¯»å–ä¸»é¢˜è®¾ç½®: 123456789
âœ… æˆåŠŸè¯»å–ä¸»é¢˜è®¾ç½®
âš ï¸ App Embed æœªå¯ç”¨
âœ… æ£€æµ‹å®Œæˆ: { isEnabled: false, themeId: '123456789', themeName: 'Dawn' }

# è‡ªåŠ¨å¯ç”¨
ğŸš€ å¼€å§‹è‡ªåŠ¨å¯ç”¨ App Embed...
ğŸš€ å¼€å§‹å¯ç”¨ App Embed...
âœ… æ‰¾åˆ°ä¸»é¢˜: Dawn ID: 123456789
ğŸ“– è¯»å–ä¸»é¢˜è®¾ç½®: 123456789
ğŸ“ æ·»åŠ  App Embed é…ç½®: app-embed-1699123456789
ğŸ’¾ æ›´æ–°ä¸»é¢˜è®¾ç½®: 123456789
âœ… æˆåŠŸæ›´æ–°ä¸»é¢˜è®¾ç½®
âœ… App Embed å¯ç”¨æˆåŠŸ: app-embed-1699123456789
```

## âš™ï¸ ç¯å¢ƒå˜é‡

ç¡®ä¿ä»¥ä¸‹ç¯å¢ƒå˜é‡å·²é…ç½®ï¼š

```bash
SHOPIFY_API_KEY=40572ca771d68b503541a8837c8b24e0
SHOPIFY_APP_HANDLE=smart-seo  # å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨ "smart-seo"
```

## ğŸ”’ å®‰å…¨æ€§

### æƒé™éªŒè¯
- âœ… æ‰€æœ‰ API è°ƒç”¨éƒ½ç»è¿‡ Shopify OAuth éªŒè¯
- âœ… ä½¿ç”¨ `authenticate.admin(request)` ç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·å¯è®¿é—®
- âœ… `accessToken` å­˜å‚¨åœ¨ä¼šè¯ä¸­ï¼Œä¸ä¼šæ³„éœ²

### æ•°æ®å®‰å…¨
- âœ… åªä¿®æ”¹ `settings_data.json` çš„ `current.blocks` éƒ¨åˆ†
- âœ… ä¸åˆ é™¤æˆ–ä¿®æ”¹å…¶ä»–ä¸»é¢˜é…ç½®
- âœ… ä½¿ç”¨ Shopify å®˜æ–¹ APIï¼Œç¬¦åˆå¹³å°è§„èŒƒ

### ç”¨æˆ·æ§åˆ¶
- âœ… ç”¨æˆ·å¯ä»¥éšæ—¶åœ¨ä¸»é¢˜ç¼–è¾‘å™¨ä¸­ç¦ç”¨
- âœ… Banner å¯ä»¥å¿½ç•¥ï¼ˆ7å¤©åé‡æ–°æé†’ï¼‰
- âœ… æä¾›æ‰‹åŠ¨è®¾ç½®é€‰é¡¹

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. **Theme App Extension è¦æ±‚**
åº”ç”¨å¿…é¡»åŒ…å« Theme App Extension æ‰èƒ½ä½¿ç”¨ App Embed åŠŸèƒ½ï¼š

```bash
# åˆ›å»º Theme App Extension
cd extensions
shopify app generate extension --type theme-app-extension
```

### 2. **Block é…ç½®æ ¼å¼**
App Embed Block çš„ `type` æ ¼å¼å¿…é¡»ä¸¥æ ¼éµå¾ªï¼š
```
shopify://apps/{APP_HANDLE}/blocks/app-embed/{API_KEY}
```

### 3. **æƒé™æ›´æ–°**
é¦–æ¬¡æ·»åŠ  `write_themes` æƒé™åï¼š
- ç”¨æˆ·éœ€è¦é‡æ–°æˆæƒåº”ç”¨
- Shopify ä¼šæ˜¾ç¤ºæƒé™å˜æ›´æç¤º
- å»ºè®®åœ¨æ›´æ–°æ—¥å¿—ä¸­è¯´æ˜æƒé™ç”¨é€”

### 4. **ä¸»é¢˜å…¼å®¹æ€§**
- âœ… æ‰€æœ‰ç°ä»£ä¸»é¢˜ï¼ˆDawn, Craft, Refresh ç­‰ï¼‰
- âœ… æ”¯æŒ Online Store 2.0 çš„ä¸»é¢˜
- âš ï¸ è€æ—§ä¸»é¢˜ï¼ˆä½¿ç”¨ Liquid 1.0ï¼‰å¯èƒ½ä¸æ”¯æŒ

### 5. **API é€Ÿç‡é™åˆ¶**
Shopify API æœ‰é€Ÿç‡é™åˆ¶ï¼š
- Theme Asset API: 40 requests/second
- å»ºè®®ç¼“å­˜æ£€æµ‹ç»“æœï¼Œé¿å…é¢‘ç¹è°ƒç”¨

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. **å‡å°‘ API è°ƒç”¨**
```typescript
// âœ… å¥½ï¼šç¼“å­˜æ£€æµ‹ç»“æœ
const [isChecking, setIsChecking] = useState(true)
// åªåœ¨é¡µé¢åŠ è½½æ—¶æ£€æµ‹ä¸€æ¬¡

// âŒ å·®ï¼šé¢‘ç¹æ£€æµ‹
setInterval(checkStatus, 1000) // ä¸è¦è¿™æ ·åš
```

### 2. **é¿å… Banner é—ªçƒ**
```typescript
// âœ… å¥½ï¼šæ£€æµ‹å®Œæˆå‰ä¸æ˜¾ç¤º
if (isChecking) return null

// âŒ å·®ï¼šç«‹å³æ˜¾ç¤º
if (!isEmbedEnabled) return <Banner />
```

### 3. **å¼‚æ­¥å¤„ç†**
æ‰€æœ‰ Theme API è°ƒç”¨éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä½¿ç”¨ `async/await` å¤„ç†ï¼š
```typescript
const result = await checkAppEmbedEnabled(admin, apiKey)
```

## ğŸ¯ æœªæ¥æ‰©å±•

### å¯èƒ½çš„åŠŸèƒ½å¢å¼º
1. **å®šæ—¶æ£€æµ‹** - å®šæœŸæ£€æŸ¥çŠ¶æ€ï¼ˆå¦‚æ¯å°æ—¶ä¸€æ¬¡ï¼‰
2. **å¤šä¸»é¢˜æ”¯æŒ** - ä¸ºæ‰€æœ‰ä¸»é¢˜å¯ç”¨ App Embed
3. **çŠ¶æ€é€šçŸ¥** - é€šè¿‡é‚®ä»¶æˆ– Webhook é€šçŸ¥çŠ¶æ€å˜åŒ–
4. **åˆ†æç»Ÿè®¡** - è®°å½•å¯ç”¨ç‡å’Œç”¨æˆ·è¡Œä¸º
5. **A/B æµ‹è¯•** - æµ‹è¯•ä¸åŒçš„æç¤ºæ–‡æ¡ˆæ•ˆæœ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Shopify Theme Asset API](https://shopify.dev/docs/api/admin-rest/2025-01/resources/asset)
- [Theme App Extensions](https://shopify.dev/docs/apps/online-store/theme-app-extensions)
- [App Embed Blocks](https://shopify.dev/docs/apps/online-store/theme-app-extensions/extensions-framework/blocks)

---

**æµ‹è¯•æ­¥éª¤ï¼š**
1. é‡å¯å¼€å‘æœåŠ¡å™¨ï¼š`npm run dev`
2. é‡æ–°å®‰è£…åº”ç”¨ï¼ˆæˆæƒæ–°æƒé™ï¼‰
3. æŸ¥çœ‹é¦–é¡µ Banner
4. ç‚¹å‡»"ä¸€é”®å¯ç”¨"
5. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
6. éªŒè¯ä¸»é¢˜ç¼–è¾‘å™¨ä¸­çš„ App Embed çŠ¶æ€

**é¢„æœŸç»“æœï¼š**
- âœ… Banner æ­£å¸¸æ˜¾ç¤º
- âœ… ä¸€é”®å¯ç”¨æˆåŠŸ
- âœ… ä¸»é¢˜ç¼–è¾‘å™¨ä¸­å¯è§ App Embed
- âœ… åˆ·æ–°é¡µé¢å Banner æ¶ˆå¤±
