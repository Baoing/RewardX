# æ•°æ®åº“åŒæ­¥æŒ‡å—

## ğŸ¯ é—®é¢˜è¯´æ˜

åœ¨ä¸åŒç”µè„‘ä¹‹é—´å¼€å‘æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°æ•°æ®åº“ schema ä¸åŒæ­¥çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š

```
PrismaClientKnownRequestError: 
The column `Session.orderVerified` does not exist in the current database.
```

è¿™æ˜¯å› ä¸ºï¼š
1. ä»£ç ä¸­çš„ Prisma schema å·²æ›´æ–°
2. ä½†æ•°æ®åº“ä¸­çš„è¡¨ç»“æ„æ²¡æœ‰åŒæ­¥
3. è¿ç§»æ–‡ä»¶å¯èƒ½æ²¡æœ‰è¢«æ­£ç¡®åº”ç”¨

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ³• 1: å¿«é€Ÿä¿®å¤ï¼ˆæ¨èï¼Œæœ€å¿«ï¼‰

å¦‚æœé‡åˆ°åˆ—ç¼ºå¤±é”™è¯¯ï¼Œæœ€å¿«çš„æ–¹æ³•æ˜¯ä½¿ç”¨ `db push`ï¼š

```bash
# æ–¹å¼ 1: ä½¿ç”¨å¿«é€Ÿä¿®å¤è„šæœ¬ï¼ˆæ¨èï¼‰
npm run db:fix

# æ–¹å¼ 2: æ‰‹åŠ¨æ‰§è¡Œ
npx prisma db push --accept-data-loss
npx prisma generate
```

**ä¼˜ç‚¹ï¼š**
- âœ… æœ€å¿«æœ€ç®€å•
- âœ… è‡ªåŠ¨åŒæ­¥æ‰€æœ‰åˆ—
- âœ… è‡ªåŠ¨æ·»åŠ ç¼ºå¤±çš„åˆ—
- âœ… è‡ªåŠ¨åˆ é™¤ schema ä¸­ä¸å­˜åœ¨çš„åˆ—
- âœ… é€‚åˆå¼€å‘ç¯å¢ƒ

**æ³¨æ„ï¼š**
- âš ï¸ è¿™ä¼šç›´æ¥ä¿®æ”¹æ•°æ®åº“ï¼Œä¸ä¼šåˆ›å»ºè¿ç§»è®°å½•
- âš ï¸ å¯èƒ½ä¼šåˆ é™¤ schema ä¸­ä¸å­˜åœ¨çš„åˆ—ï¼ˆå¦‚ `requireEmail`, `emailVerified`, `email`ï¼‰
- âš ï¸ ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨è¿ç§»æ–‡ä»¶
- âœ… åˆ é™¤æ—§åˆ—æ˜¯æ­£å¸¸çš„ï¼Œè¯´æ˜ schema å·²æ›´æ–°

### æ–¹æ³• 2: ä½¿ç”¨åŒæ­¥è„šæœ¬

åœ¨æ–°ç”µè„‘ä¸Šå…‹éš†ä»£ç åï¼Œè¿è¡Œï¼š

```bash
# æ–¹å¼ 1: ä½¿ç”¨ npm è„šæœ¬
npm run db:sync

# æ–¹å¼ 2: ç›´æ¥è¿è¡Œè„šæœ¬
./sync-database.sh
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
1. âœ… æ£€æŸ¥æ•°æ®åº“è¿æ¥
2. âœ… æ£€æŸ¥è¿ç§»çŠ¶æ€
3. âœ… åº”ç”¨æ‰€æœ‰æœªåº”ç”¨çš„è¿ç§»
4. âœ… å¦‚æœè¿ç§»å¤±è´¥ï¼Œè‡ªåŠ¨ä½¿ç”¨ db push
5. âœ… ç”Ÿæˆ Prisma Client

### æ–¹æ³• 2: æ‰‹åŠ¨åŒæ­¥

å¦‚æœè„šæœ¬æ— æ³•è¿è¡Œï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼š

```bash
# 1. åº”ç”¨æ‰€æœ‰è¿ç§»
npm run db:deploy
# æˆ–
npx prisma migrate deploy

# 2. å¦‚æœ migrate deploy å¤±è´¥ï¼Œä½¿ç”¨ db pushï¼ˆä¼šç›´æ¥ä¿®æ”¹æ•°æ®åº“ï¼‰
npm run db:push
# æˆ–
npx prisma db push

# 3. ç”Ÿæˆ Prisma Client
npm run db:generate
# æˆ–
npx prisma generate
```

### æ–¹æ³• 3: å¼ºåˆ¶åŒæ­¥ï¼ˆå¦‚æœè¿ç§»æœ‰é—®é¢˜ï¼‰

å¦‚æœè¿ç§»æ–‡ä»¶æœ‰é—®é¢˜ï¼Œå¯ä»¥å¼ºåˆ¶åŒæ­¥ï¼š

```bash
# âš ï¸ è­¦å‘Šï¼šè¿™ä¼šç›´æ¥ä¿®æ”¹æ•°æ®åº“ï¼Œä¸ä¼šåˆ›å»ºè¿ç§»è®°å½•
npx prisma db push --accept-data-loss
npx prisma generate
```

## ğŸ“‹ æ–°ç”µè„‘è®¾ç½®æµç¨‹

### 1. å…‹éš†ä»£ç 

```bash
git clone <repository-url>
cd RewardX
```

### 2. å®‰è£…ä¾èµ–

```bash
npm install
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

ç¡®ä¿ `.env` æ–‡ä»¶ä¸­æœ‰æ­£ç¡®çš„æ•°æ®åº“é…ç½®ï¼š

```env
DATABASE_URL="postgresql://rewardx:rewardx_password@localhost:5432/rewardx?schema=public"
```

### 4. å¯åŠ¨æ•°æ®åº“ï¼ˆå¦‚æœä½¿ç”¨ Dockerï¼‰

```bash
npm run docker:up
# æˆ–
docker compose up -d postgres
```

### 5. åŒæ­¥æ•°æ®åº“

```bash
npm run db:sync
```

### 6. éªŒè¯

```bash
# æ£€æŸ¥è¿ç§»çŠ¶æ€
npm run db:status

# æ‰“å¼€æ•°æ®åº“ç®¡ç†ç•Œé¢
npm run db:studio
```

## ğŸ” å¸¸è§é—®é¢˜

### Q: é‡åˆ° "column does not exist" é”™è¯¯æ€ä¹ˆåŠï¼Ÿ

A: è¿™æ˜¯æœ€å¸¸è§çš„é”™è¯¯ï¼Œå¿«é€Ÿä¿®å¤æ–¹æ³•ï¼š

```bash
# æ–¹æ³• 1: ä½¿ç”¨ db pushï¼ˆæœ€å¿«ï¼‰
npx prisma db push --accept-data-loss
npx prisma generate

# æ–¹æ³• 2: ä½¿ç”¨åŒæ­¥è„šæœ¬
npm run db:sync
```

### Q: `migrate deploy` å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

A: å°è¯•ä½¿ç”¨ `db push`ï¼š
```bash
npx prisma db push --accept-data-loss
npx prisma generate
```

### Q: å¦‚ä½•å¿«é€Ÿä¿®å¤æ‰€æœ‰åˆ—ç¼ºå¤±é—®é¢˜ï¼Ÿ

A: ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸€é”®ä¿®å¤ï¼š
```bash
npm run db:fix
# æˆ–
npx prisma db push --accept-data-loss && npx prisma generate
```

è¿™ä¸ªå‘½ä»¤ä¼šï¼š
- âœ… æ£€æŸ¥ schema å’Œæ•°æ®åº“çš„å·®å¼‚
- âœ… è‡ªåŠ¨æ·»åŠ ç¼ºå¤±çš„åˆ—
- âœ… è‡ªåŠ¨ä¿®æ”¹ç±»å‹ä¸åŒ¹é…çš„åˆ—
- âœ… è‡ªåŠ¨åˆ é™¤ schema ä¸­ä¸å­˜åœ¨çš„æ—§åˆ—
- âœ… é‡æ–°ç”Ÿæˆ Prisma Client

### Q: çœ‹åˆ° "You are about to drop the column" è­¦å‘Šæ€ä¹ˆåŠï¼Ÿ

A: è¿™æ˜¯æ­£å¸¸çš„ï¼è¿™äº›è­¦å‘Šè¡¨ç¤ºï¼š
- âœ… æ•°æ®åº“ä¸­æœ‰ä¸€äº›æ—§åˆ—ï¼ˆå¦‚ `requireEmail`, `emailVerified`, `email`ï¼‰
- âœ… è¿™äº›åˆ—åœ¨æ–°ç‰ˆæœ¬çš„ schema ä¸­å·²ç»ä¸å­˜åœ¨äº†
- âœ… `db push` ä¼šè‡ªåŠ¨åˆ é™¤è¿™äº›æ—§åˆ—ï¼Œä½¿æ•°æ®åº“ä¸ schema åŒæ­¥

**è¿™æ˜¯æ­£å¸¸çš„æ¸…ç†è¿‡ç¨‹ï¼Œå¯ä»¥å®‰å…¨åœ°ç»§ç»­ã€‚**

### Q: å¦‚ä½•é¿å…æ¯æ¬¡éƒ½è¦ä¿®å¤ï¼Ÿ

A: åœ¨æ–°ç”µè„‘ä¸Šè®¾ç½®æ—¶ï¼š
1. âœ… å…ˆè¿è¡Œ `npm run db:sync` åº”ç”¨æ‰€æœ‰è¿ç§»
2. âœ… å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¿è¡Œ `npm run db:fix` å¼ºåˆ¶åŒæ­¥
3. âœ… ç¡®ä¿æ‰€æœ‰è¿ç§»æ–‡ä»¶éƒ½åœ¨ Git ä¸­

### Q: å¦‚ä½•æŸ¥çœ‹æ•°æ®åº“å½“å‰çŠ¶æ€ï¼Ÿ

A: ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash
# æŸ¥çœ‹è¿ç§»çŠ¶æ€
npm run db:status

# æ‰“å¼€æ•°æ®åº“ç®¡ç†ç•Œé¢
npm run db:studio
```

### Q: å¦‚ä½•é‡ç½®æ•°æ®åº“ï¼Ÿ

A: âš ï¸ è­¦å‘Šï¼šè¿™ä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼
```bash
npm run db:reset
```

### Q: å¦‚ä½•æŸ¥çœ‹è¿ç§»å†å²ï¼Ÿ

A: 
```bash
ls prisma/migrations/
```

## ğŸ“ æœ€ä½³å®è·µ

1. **æäº¤è¿ç§»æ–‡ä»¶åˆ° Git**
   - âœ… ç¡®ä¿æ‰€æœ‰è¿ç§»æ–‡ä»¶éƒ½åœ¨ Git ä¸­
   - âœ… ä¸è¦åˆ é™¤ `prisma/migrations/` ç›®å½•

2. **åœ¨æ–°ç”µè„‘ä¸Šå…ˆåŒæ­¥æ•°æ®åº“**
   - âœ… å…‹éš†ä»£ç åç«‹å³è¿è¡Œ `npm run db:sync`
   - âœ… ç¡®ä¿æ•°æ®åº“ schema ä¸ä»£ç åŒæ­¥

3. **å®šæœŸæ£€æŸ¥è¿ç§»çŠ¶æ€**
   - âœ… è¿è¡Œ `npm run db:status` æ£€æŸ¥æ˜¯å¦æœ‰æœªåº”ç”¨çš„è¿ç§»
   - âœ… åœ¨å¼€å‘æ–°åŠŸèƒ½å‰ç¡®ä¿æ•°æ®åº“æ˜¯æœ€æ–°çš„

4. **ä¸è¦æ‰‹åŠ¨ä¿®æ”¹æ•°æ®åº“**
   - âŒ ä¸è¦ç›´æ¥åœ¨æ•°æ®åº“ä¸­ä¿®æ”¹è¡¨ç»“æ„
   - âœ… ä½¿ç”¨ Prisma schema å’Œè¿ç§»æ–‡ä»¶æ¥ç®¡ç†æ•°æ®åº“ç»“æ„

## ğŸ› ï¸ å¯ç”¨å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `npm run db:sync` | åŒæ­¥æ•°æ®åº“ï¼ˆæ¨èï¼‰ |
| `npm run db:deploy` | åº”ç”¨æ‰€æœ‰è¿ç§» |
| `npm run db:push` | ç›´æ¥æ¨é€ schema åˆ°æ•°æ®åº“ |
| `npm run db:status` | æŸ¥çœ‹è¿ç§»çŠ¶æ€ |
| `npm run db:studio` | æ‰“å¼€æ•°æ®åº“ç®¡ç†ç•Œé¢ |
| `npm run db:generate` | ç”Ÿæˆ Prisma Client |
| `npm run db:reset` | é‡ç½®æ•°æ®åº“ï¼ˆâš ï¸ ä¼šåˆ é™¤æ•°æ®ï¼‰ |

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Prisma è¿ç§»æ–‡æ¡£](https://www.prisma.io/docs/concepts/components/prisma-migrate)
- [æ•°æ®åº“åˆå§‹åŒ–æŒ‡å—](./DATABASE_SETUP.md)
- [æ•°æ®åº“æ›´æ–°æŒ‡å—](./DATABASE_UPDATE.md)

