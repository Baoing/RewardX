# 宝塔面板 PostgreSQL 权限设置步骤

## 问题
PostgreSQL 服务器不允许从外部 IP 直接连接 `postgres` 用户（安全配置）。

## 解决方案：在宝塔面板中执行 SQL

### 方法 1: 使用宝塔面板的 PostgreSQL 管理界面（推荐）

1. **登录宝塔面板**
   - 访问你的宝塔面板地址

2. **打开 PostgreSQL 管理**
   - 左侧菜单：**数据库** → **PostgreSQL 管理**
   - 或者：**软件商店** → 找到 PostgreSQL → **管理**

3. **使用 postgres 用户登录**
   - 点击 **"phpPgAdmin"** 或 **"SQL 执行"** 按钮
   - 或者直接进入 PostgreSQL 管理界面
   - 用户名：`postgres`
   - 密码：`fk6SxahXX87aDxrr`

4. **选择数据库**
   - 在左侧选择数据库：`Rewardx`

5. **执行 SQL**
   - 打开 SQL 执行界面（Query Tool 或 SQL 编辑器）
   - 复制 `grant_permissions.sql` 文件中的内容
   - 粘贴并执行

### 方法 2: 通过 SSH 在服务器上执行

1. **SSH 连接到服务器**
   ```bash
   ssh root@194.41.36.92
   ```

2. **切换到 postgres 用户**
   ```bash
   su - postgres
   ```

3. **连接到数据库**
   ```bash
   psql -d Rewardx
   ```

4. **执行权限授予命令**
   ```sql
   GRANT ALL PRIVILEGES ON SCHEMA public TO "Rewardx";
   GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO "Rewardx";
   GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO "Rewardx";
   ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO "Rewardx";
   ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO "Rewardx";
   ALTER USER "Rewardx" WITH CREATEDB;
   \du "Rewardx"
   \q
   ```

5. **或者直接执行脚本**
   ```bash
   # 上传 grant_permissions_on_server.sh 到服务器
   bash grant_permissions_on_server.sh
   ```

## 需要执行的 SQL 命令

```sql
-- 授予 Rewardx 用户在 public schema 上的所有权限
GRANT ALL PRIVILEGES ON SCHEMA public TO "Rewardx";

-- 授予现有表的权限（如果有）
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO "Rewardx";

-- 授予序列的权限
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO "Rewardx";

-- 设置默认权限（未来创建的表和序列）
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO "Rewardx";
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO "Rewardx";

-- 允许用户创建数据库（可选）
ALTER USER "Rewardx" WITH CREATEDB;
```

## 验证权限

执行后可以验证：

```sql
-- 查看用户信息
\du "Rewardx"
```

应该看到 Rewardx 用户有 CREATEDB 权限。

## 完成权限设置后

回到本地项目，执行：

```bash
# 运行迁移
npx prisma migrate deploy

# 生成 Prisma Client
npx prisma generate

# 验证状态
npx prisma migrate status
```

## 注意事项

- ⚠️ 不要将 Rewardx 设置为超级用户（SUPERUSER）
- ✅ 只需要授予在 `public` schema 上的权限即可
- ✅ 使用 `postgres` 超级用户执行上述命令

